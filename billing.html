<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Writer Pro — Billing</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="page-enter">
    <header class="hero">
      <nav class="nav">
        <a class="logo" href="index.html">WRITER PRO</a>
        <div class="nav-actions">
          <a class="btn btn-outline page-link" href="index.html">HOME</a>
          <a class="btn btn-outline page-link" href="index.html#download">DOWNLOAD</a>
          <a class="btn btn-outline page-link" id="nav-auth" href="app.html">SIGN IN</a>
        </div>
      </nav>

      <div class="hero-grid">
        <div class="hero-copy">
          <h1>BILLING</h1>
          <p class="subtitle">Choose a plan after login. Checkout is locked until signed in.</p>
        </div>
      </div>
    </header>

    <section class="section" id="billing">
      <div class="account-grid">
        <div class="card">
          <h3>ACCOUNT STATUS</h3>
          <p id="auth-state">Checking session...</p>
          <div class="credit-balance" id="credits">Balance: —</div>
          <div class="cta-row">
            <a class="btn btn-primary page-link" href="app.html" id="signin-link">Sign In</a>
            <button class="btn btn-outline" id="logout">Sign Out</button>
          </div>
          <p class="notice" id="billing-status"></p>
        </div>

        <div class="card">
          <h3>SUBSCRIPTIONS</h3>
          <div class="pricing-grid account-pricing-grid">
            <button class="btn btn-outline buy" data-pack="credits_65_monthly">Monthly 65 • $4.99 CAD</button>
            <button class="btn btn-outline buy" data-pack="credits_180_monthly">Monthly 180 • $11.99 CAD</button>
            <button class="btn btn-outline buy" data-pack="credits_430_monthly">Monthly 430 • $24.99 CAD</button>
          </div>
          <div class="cta-row" style="margin-top: 12px;">
            <button class="btn btn-outline" id="portal">Manage Subscription</button>
          </div>
        </div>

        <div class="card">
          <h3>ONE-TIME CREDITS</h3>
          <div class="pricing-grid account-pricing-grid">
            <button class="btn btn-outline buy" data-pack="credits_100">Buy 100 • $9.99 CAD</button>
            <button class="btn btn-outline buy" data-pack="credits_220">Buy 220 • $19.99 CAD</button>
          </div>
          <div class="cta-row" style="margin-top: 12px;">
            <button class="btn btn-primary" id="refresh">Refresh Credits</button>
          </div>
        </div>

        <div class="card">
          <h3>ACCOUNT SETTINGS</h3>
          <p>Simple settings you can control from the web dashboard.</p>
          <div class="form-stack">
            <input class="input" id="settings-name" type="text" placeholder="Display name" />
            <label class="agree">
              <input type="checkbox" id="settings-emails" />
              <span>Receive product update emails</span>
            </label>
            <label class="agree">
              <input type="checkbox" id="settings-reduced-motion" />
              <span>Reduced motion on website</span>
            </label>
            <label class="agree">
              <input type="checkbox" id="settings-auto-refresh" />
              <span>Auto refresh credits on dashboard open</span>
            </label>
            <label class="agree">
              <input type="checkbox" id="settings-confirm-checkout" />
              <span>Ask before starting checkout</span>
            </label>
            <label class="agree">
              <input type="checkbox" id="settings-open-new-tab" />
              <span>Open checkout/portal in a new tab</span>
            </label>
            <select class="input" id="settings-preferred-pack">
              <option value="">Preferred pack (none)</option>
              <option value="credits_65_monthly">Monthly 65</option>
              <option value="credits_100">One-time 100</option>
              <option value="credits_180_monthly">Monthly 180</option>
              <option value="credits_220">One-time 220</option>
              <option value="credits_430_monthly">Monthly 430</option>
            </select>
            <button class="btn btn-primary" id="settings-save">Save Settings</button>
            <p class="notice" id="settings-status"></p>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="footer-links">
        <a href="terms.html">Terms</a>
        <a href="privacy.html">Privacy</a>
      </div>
    </footer>

    <script>
      const SUPABASE_URL = "https://vnzlaidwxgiaowhxtuvi.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuemxhaWR3eGdpYW93aHh0dXZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjcwNzksImV4cCI6MjA4NDQwMzA3OX0.AKiGX3xbgMKtUFYxHKEaAKwacFqmjPEsy56ofU1eDQQ";
      const FN_CREATE_CHECKOUT = "create-checkout-session";
      const FN_PORTAL = "create-portal-session";

      const authState = document.getElementById("auth-state");
      const billingStatus = document.getElementById("billing-status");
      const creditsEl = document.getElementById("credits");
      const buyButtons = Array.from(document.querySelectorAll(".buy"));
      const portalButton = document.getElementById("portal");
      const refreshButton = document.getElementById("refresh");
      const navAuthBtn = document.getElementById("nav-auth");
      const signinLink = document.getElementById("signin-link");
      const logoutBtn = document.getElementById("logout");
      const settingsName = document.getElementById("settings-name");
      const settingsEmails = document.getElementById("settings-emails");
      const settingsReducedMotion = document.getElementById("settings-reduced-motion");
      const settingsAutoRefresh = document.getElementById("settings-auto-refresh");
      const settingsConfirmCheckout = document.getElementById("settings-confirm-checkout");
      const settingsOpenNewTab = document.getElementById("settings-open-new-tab");
      const settingsPreferredPack = document.getElementById("settings-preferred-pack");
      const settingsSave = document.getElementById("settings-save");
      const settingsStatus = document.getElementById("settings-status");
      let session = null;
      function hasSessionToken() {
        return !!(session && session.access_token);
      }
      function ingestSessionFromHash() {
        const hash = window.location.hash ? window.location.hash.substring(1) : "";
        if (!hash) return;
        const params = new URLSearchParams(hash);
        const accessToken = params.get("access_token");
        const refreshToken = params.get("refresh_token");
        if (!accessToken) return;
        const expiresAt = parseInt(params.get("expires_at") || "0", 10) || undefined;
        const tokenType = params.get("token_type") || "bearer";
        storeSession({
          access_token: accessToken,
          refresh_token: refreshToken,
          expires_at: expiresAt,
          token_type: tokenType
        });
        history.replaceState(null, "", window.location.pathname + window.location.search);
      }
      function storeSession(next) {
        session = next;
        if (next) {
          const serialized = JSON.stringify(next);
          localStorage.setItem("wp_session", serialized);
          sessionStorage.setItem("wp_session", serialized);
        } else {
          localStorage.removeItem("wp_session");
          sessionStorage.removeItem("wp_session");
        }
      }
      const params = new URLSearchParams(window.location.search);
      const requestedPackId = params.get("pack_id");

      function loadSession() {
        try {
          const raw = localStorage.getItem("wp_session");
          const fallback = sessionStorage.getItem("wp_session");
          if (raw || fallback) session = JSON.parse(raw || fallback);
        } catch {
          session = null;
        }
      }

      function navigateWithFade(url) {
        document.body.classList.add("page-exit");
        setTimeout(() => { window.location.href = url; }, 240);
      }

      document.querySelectorAll(".page-link").forEach((link) => {
        link.addEventListener("click", (event) => {
          if (link.id === "nav-auth" && hasSessionToken()) {
            event.preventDefault();
            signOut();
            return;
          }
          const href = link.getAttribute("href") || "";
          if (href.startsWith("#")) return;
          event.preventDefault();
          navigateWithFade(href);
        });
      });

      function setBillingLocked(locked) {
        portalButton.disabled = locked;
        refreshButton.disabled = locked;
      }

      function markRequestedPack() {
        const selectedPack = requestedPackId || settingsPreferredPack.value;
        if (!selectedPack) return;
        let found = false;
        buyButtons.forEach((btn) => {
          const selected = btn.dataset.pack === selectedPack;
          btn.classList.toggle("is-selected", selected);
          if (selected) found = true;
        });
        if (found) {
          billingStatus.textContent = "Selected plan ready. Click it to continue checkout.";
        }
      }

      function updateSessionUI() {
        const signedIn = hasSessionToken();
        navAuthBtn.textContent = signedIn ? "SIGN OUT" : "SIGN IN";
        navAuthBtn.setAttribute("href", signedIn ? "#" : "app.html");
        signinLink.style.display = signedIn ? "none" : "inline-flex";
        logoutBtn.style.display = signedIn ? "inline-flex" : "none";
      }

      function isSessionNearExpiry() {
        if (!session || !session.expires_at) return false;
        const now = Math.floor(Date.now() / 1000);
        return now >= (session.expires_at - 45);
      }

      async function refreshSession() {
        if (!session || !session.refresh_token) return false;
        try {
          const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=refresh_token`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY
            },
            body: JSON.stringify({ refresh_token: session.refresh_token })
          });
          if (!res.ok) return false;
          const next = await res.json();
          if (!next || !next.access_token) return false;
          storeSession(next);
          updateSessionUI();
          return true;
        } catch {
          return false;
        }
      }

      async function ensureFreshSession() {
        if (!hasSessionToken()) return false;
        if (isSessionNearExpiry()) {
          return await refreshSession();
        }
        return true;
      }

      async function validateSession() {
        if (!hasSessionToken()) return false;
        try {
          const res = await supabaseRequest("/auth/v1/user", { method: "GET" });
          if (res && res.ok) return true;
          if (res && res.status === 401) {
            const refreshed = await refreshSession();
            if (!refreshed) return false;
            const retry = await supabaseRequest("/auth/v1/user", { method: "GET" }, false);
            return !!(retry && retry.ok);
          }
          return false;
        } catch {
          return false;
        }
      }

      function loadSettings() {
        try {
          if (settingsName) settingsName.value = localStorage.getItem("wp_settings_name") || "";
          if (settingsEmails) settingsEmails.checked = localStorage.getItem("wp_settings_emails") === "1";
          if (settingsReducedMotion) settingsReducedMotion.checked = localStorage.getItem("wp_settings_reduced_motion") === "1";
          if (settingsAutoRefresh) settingsAutoRefresh.checked = localStorage.getItem("wp_settings_auto_refresh") !== "0";
          if (settingsConfirmCheckout) settingsConfirmCheckout.checked = localStorage.getItem("wp_settings_confirm_checkout") !== "0";
          if (settingsOpenNewTab) settingsOpenNewTab.checked = localStorage.getItem("wp_settings_open_new_tab") === "1";
          if (settingsPreferredPack) settingsPreferredPack.value = localStorage.getItem("wp_settings_preferred_pack") || "";
          document.body.classList.toggle("reduced-motion", !!(settingsReducedMotion && settingsReducedMotion.checked));
        } catch {
          if (settingsStatus) settingsStatus.textContent = "Could not load settings in this browser mode.";
        }
      }

      function saveSettings() {
        try {
          localStorage.setItem("wp_settings_name", settingsName ? settingsName.value.trim() : "");
          localStorage.setItem("wp_settings_emails", settingsEmails && settingsEmails.checked ? "1" : "0");
          localStorage.setItem("wp_settings_reduced_motion", settingsReducedMotion && settingsReducedMotion.checked ? "1" : "0");
          localStorage.setItem("wp_settings_auto_refresh", settingsAutoRefresh && settingsAutoRefresh.checked ? "1" : "0");
          localStorage.setItem("wp_settings_confirm_checkout", settingsConfirmCheckout && settingsConfirmCheckout.checked ? "1" : "0");
          localStorage.setItem("wp_settings_open_new_tab", settingsOpenNewTab && settingsOpenNewTab.checked ? "1" : "0");
          localStorage.setItem("wp_settings_preferred_pack", settingsPreferredPack ? settingsPreferredPack.value : "");
          document.body.classList.toggle("reduced-motion", !!(settingsReducedMotion && settingsReducedMotion.checked));
          markRequestedPack();
          if (settingsStatus) settingsStatus.textContent = "Settings saved.";
        } catch {
          if (settingsStatus) settingsStatus.textContent = "Settings could not be saved (browser blocked storage).";
        }
      }

      async function supabaseRequest(path, options, retry = true) {
        const headers = options.headers || {};
        headers["apikey"] = SUPABASE_ANON_KEY;
        if (hasSessionToken()) headers["Authorization"] = `Bearer ${session.access_token}`;
        const response = await fetch(`${SUPABASE_URL}${path}`, { ...options, headers });
        if (response.status === 401 && retry && session && session.refresh_token) {
          const refreshed = await refreshSession();
          if (refreshed) {
            return supabaseRequest(path, options, false);
          }
        }
        return response;
      }

      async function remoteSignOut() {
        if (!hasSessionToken()) return;
        try {
          await supabaseRequest("/auth/v1/logout", { method: "POST", headers: { "Content-Type": "application/json" } });
        } catch {}
      }

      async function refreshCredits() {
        if (!hasSessionToken()) return;
        await ensureFreshSession();
        billingStatus.textContent = "Refreshing...";
        const userRes = await supabaseRequest("/auth/v1/user", { method: "GET" });
        if (!userRes.ok) {
          billingStatus.textContent = "Failed to load profile.";
          return;
        }
        const user = await userRes.json();
        const email = user ? user.email : "";
        const res = await supabaseRequest(`/rest/v1/profiles?select=credits,email,is_admin&email=eq.${encodeURIComponent(email)}`, {
          method: "GET",
          headers: { "Content-Type": "application/json" }
        });
        if (!res.ok) {
          billingStatus.textContent = "Failed to load credits.";
          return;
        }
        const data = await res.json();
        const nextCredits = (data && data[0] && typeof data[0].credits === "number") ? data[0].credits : 0;
        creditsEl.textContent = `Balance: ${nextCredits}`;
        billingStatus.textContent = "";
      }

      async function startCheckout(packId) {
        if (!hasSessionToken()) {
          billingStatus.textContent = "Sign in required before checkout. Redirecting...";
          const targetBilling = packId ? `billing.html?pack_id=${encodeURIComponent(packId)}` : "billing.html";
          navigateWithFade(`app.html?next=${encodeURIComponent(targetBilling)}`);
          return;
        }
        if (settingsConfirmCheckout.checked && !window.confirm("Open Stripe checkout for this credit pack?")) {
          billingStatus.textContent = "Checkout canceled.";
          return;
        }
        const fresh = await ensureFreshSession();
        if (!fresh) {
          billingStatus.textContent = "Session expired. Please sign in again.";
          setBillingLocked(true);
          navigateWithFade("app.html?signed_out=1");
          return;
        }
        buyButtons.forEach((btn) => btn.classList.toggle("is-selected", btn.dataset.pack === packId));
        billingStatus.textContent = "Opening checkout...";
        try {
          const res = await supabaseRequest(`/functions/v1/${FN_CREATE_CHECKOUT}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pack_id: packId })
          });
          if (!res.ok) {
            let detail = "";
            try {
              const payload = await res.json();
              detail = (payload && (payload.error || payload.message)) || "";
            } catch {}
            if (res.status === 401) {
              billingStatus.textContent = "Session expired. Please sign in again.";
              setBillingLocked(true);
              return;
            }
            if (res.status === 404) {
              billingStatus.textContent = "Checkout service not found. Confirm Edge Function deployment.";
              return;
            }
            billingStatus.textContent = detail ? `Checkout failed: ${detail}` : `Checkout failed (HTTP ${res.status}).`;
            return;
          }
          const payload = await res.json();
          if (!payload || !payload.url) {
            billingStatus.textContent = "Checkout failed: missing checkout URL.";
            return;
          }
          if (settingsOpenNewTab.checked) {
            window.open(payload.url, "_blank", "noopener,noreferrer");
            billingStatus.textContent = "Checkout opened in a new tab.";
          } else {
            window.location.href = payload.url;
          }
        } catch (error) {
          billingStatus.textContent = `Checkout failed: ${(error && error.message) || "network error"}`;
        }
      }

      async function openPortal() {
        if (!hasSessionToken()) {
          billingStatus.textContent = "Sign in required before opening portal.";
          navigateWithFade("app.html?next=billing.html");
          return;
        }
        const fresh = await ensureFreshSession();
        if (!fresh) {
          billingStatus.textContent = "Session expired. Please sign in again.";
          setBillingLocked(true);
          navigateWithFade("app.html?signed_out=1");
          return;
        }
        billingStatus.textContent = "Opening portal...";
        try {
          const res = await supabaseRequest(`/functions/v1/${FN_PORTAL}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({})
          });
          if (!res.ok) {
            let detail = "";
            try {
              const payload = await res.json();
              detail = (payload && (payload.error || payload.message)) || "";
            } catch {}
            billingStatus.textContent = detail ? `Portal failed: ${detail}` : `Portal failed (HTTP ${res.status}).`;
            if (res.status === 401) {
              billingStatus.textContent = "Session expired. Please sign in again.";
              setBillingLocked(true);
            }
            return;
          }
          const payload = await res.json();
          if (!payload || !payload.url) {
            billingStatus.textContent = "Portal failed: missing portal URL.";
            return;
          }
          if (settingsOpenNewTab.checked) {
            window.open(payload.url, "_blank", "noopener,noreferrer");
            billingStatus.textContent = "Portal opened in a new tab.";
          } else {
            window.location.href = payload.url;
          }
        } catch (error) {
          billingStatus.textContent = `Portal failed: ${(error && error.message) || "network error"}`;
        }
      }

      async function signOut() {
        await remoteSignOut();
        storeSession(null);
        setBillingLocked(true);
        updateSessionUI();
        authState.textContent = "Signed out. Please sign in to continue.";
        creditsEl.textContent = "Balance: —";
        navigateWithFade("app.html?signed_out=1");
      }

      buyButtons.forEach((btn) => btn.addEventListener("click", () => startCheckout(btn.dataset.pack)));
      portalButton.addEventListener("click", openPortal);
      refreshButton.addEventListener("click", refreshCredits);
      document.getElementById("logout").addEventListener("click", signOut);
      if (settingsSave) settingsSave.addEventListener("click", saveSettings);
      if (settingsReducedMotion) {
        settingsReducedMotion.addEventListener("change", () => {
          document.body.classList.toggle("reduced-motion", settingsReducedMotion.checked);
        });
      }

      ingestSessionFromHash();
      loadSession();
      loadSettings();
      updateSessionUI();
      (async function initBilling() {
        if (!hasSessionToken()) {
          const targetBilling = requestedPackId
            ? `billing.html?pack_id=${encodeURIComponent(requestedPackId)}`
            : "billing.html";
          const signInUrl = new URL(`app.html?next=${encodeURIComponent(targetBilling)}`, window.location.href).toString();
          window.location.replace(signInUrl);
          return;
        }

        const valid = await validateSession();
        if (!valid) {
          const targetBilling = requestedPackId
            ? `billing.html?pack_id=${encodeURIComponent(requestedPackId)}`
            : "billing.html";
          const signInUrl = new URL(`app.html?signed_out=1&next=${encodeURIComponent(targetBilling)}`, window.location.href).toString();
          window.location.replace(signInUrl);
          return;
        }

        setBillingLocked(false);
        authState.textContent = "Signed in.";
        markRequestedPack();
        if (settingsAutoRefresh.checked) {
          await refreshCredits();
        } else {
          billingStatus.textContent = "Auto refresh disabled in settings.";
        }

        const checkoutParams = new URLSearchParams(window.location.search);
        if (checkoutParams.get("checkout") === "success") {
          billingStatus.textContent = "Purchase complete. Refreshing credits...";
          await refreshCredits();
        }
      })();
    </script>
  </body>
</html>
