<!doctype html>
<html lang="en">
  <head>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
    <link rel="icon" type="image/png" sizes="64x64" href="favicon-64.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="favicon-512.png">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Writer Pro — Referral Credits</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="legal-page page-enter">
    <header class="hero legal-hero">
      <nav class="nav">
        <a class="logo" href="index.html">WRITER PRO</a>
        <div class="nav-actions">
          <a class="btn btn-outline page-link" href="index.html">HOME</a>
          <a class="btn btn-outline page-link" href="billing.html">BILLING</a>
          <a class="btn btn-outline page-link" href="support.html">SUPPORT</a>
        </div>
      </nav>
      <div class="hero-grid legal-hero-grid">
        <div class="hero-copy legal-hero-copy">
          <h1>REFERRAL CREDITS</h1>
          <p class="subtitle">Share your referral code and earn bonus credits.</p>
        </div>
      </div>
    </header>

    <section class="section">
      <div class="legal-shell">
        <div class="legal-card">
          <h2>How it works</h2>
          <ul class="legal-list">
            <li>Every new account starts with <strong>5 credits</strong>.</li>
            <li>If a new user enters a valid referral code during signup, they get <strong>+5 credits</strong>.</li>
            <li>You get <strong>+5 credits</strong> every time a new user uses your referral code.</li>
            <li>Each account can apply a referral code only once (you can’t use your own).</li>
          </ul>
          <div class="legal-note">Share your referral code so new users can enter it during setup.</div>
        </div>

        <div class="legal-card">
          <h2>Your referral code</h2>
          <p class="subtle">Copy your referral code and share it with new users.</p>
          <div class="referral-row" style="margin-top: 12px;">
            <div class="referral-label">Referral code</div>
            <div class="referral-box">
              <span class="referral-code" id="referral-code">—</span>
              <button class="btn btn-outline btn-small" id="copy-referral" type="button">Copy</button>
            </div>
          </div>
          <div class="form-stack" style="margin-top: 12px;">
            <div class="cta-row" style="margin-top: 2px;">
              <a class="btn btn-outline page-link" href="billing.html">Open Billing</a>
            </div>
            <a class="btn btn-outline page-link" href="app.html" id="referral-signin" style="display:none;">Sign In to Load Your Code</a>
            <p class="notice" id="referral-status"></p>
          </div>
        </div>

        <div class="legal-card">
          <h2>Step‑by‑step</h2>
          <div class="step-list">
            <div class="step-row">
              <div class="step-index">1</div>
              <div class="step-body">
                <h3>Find your referral code</h3>
                <p>Open Billing and look for “Referral code.”</p>
                <div class="step-media">
                  <div class="mock-window">
                    <div class="mock-topbar">
                      <div class="mock-dots">
                        <span class="mock-dot red"></span>
                        <span class="mock-dot yellow"></span>
                        <span class="mock-dot green"></span>
                      </div>
                      <div class="mock-title">Billing • Referral Code</div>
                      <div style="width:22px;"></div>
                    </div>
                    <div class="mock-content">
                      <div class="mock-panel">
                        <div class="mock-row md"></div>
                        <div class="mock-code">ABCD12EFGH</div>
                        <div class="mock-actions">
                          <div class="mock-button primary">Copy</div>
                          <div class="mock-button">Share</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="step-row">
              <div class="step-index">2</div>
              <div class="step-body">
                <h3>Share your referral code</h3>
                <p>Send your referral code to a new user and ask them to enter it during setup.</p>
                <div class="step-media">
                  <div class="mock-window">
                    <div class="mock-topbar">
                      <div class="mock-dots">
                        <span class="mock-dot red"></span>
                        <span class="mock-dot yellow"></span>
                        <span class="mock-dot green"></span>
                      </div>
                      <div class="mock-title">Referral Code</div>
                      <div style="width:22px;"></div>
                    </div>
                    <div class="mock-content">
                      <div class="mock-row sm"></div>
                      <div class="mock-code">ABCD12EFGH</div>
                      <div class="mock-actions">
                        <div class="mock-button primary">Copy Code</div>
                        <div class="mock-button">Send</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="step-row">
              <div class="step-index">3</div>
              <div class="step-body">
                <h3>They create an account</h3>
                <p>After signup, they’ll be asked for an optional referral code during setup.</p>
                <div class="step-media">
                  <div class="mock-window">
                    <div class="mock-topbar">
                      <div class="mock-dots">
                        <span class="mock-dot red"></span>
                        <span class="mock-dot yellow"></span>
                        <span class="mock-dot green"></span>
                      </div>
                      <div class="mock-title">Create Account</div>
                      <div style="width:22px;"></div>
                    </div>
                    <div class="mock-content">
                      <div class="mock-input"></div>
                      <div class="mock-input"></div>
                      <div class="mock-actions">
                        <div class="mock-button primary">Create Account</div>
                        <div class="mock-button">Sign In</div>
                      </div>
                      <div class="mock-panel">
                        <div class="mock-row xs"></div>
                        <div class="mock-pill active"><span class="dot"></span> Referral code applied</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="step-row">
              <div class="step-index">4</div>
              <div class="step-body">
                <h3>Credits are added</h3>
                <p>They get +5 credits, and you get +5 credits. Refresh Billing if it doesn’t update right away.</p>
                <div class="step-media">
                  <div class="mock-window">
                    <div class="mock-topbar">
                      <div class="mock-dots">
                        <span class="mock-dot red"></span>
                        <span class="mock-dot yellow"></span>
                        <span class="mock-dot green"></span>
                      </div>
                      <div class="mock-title">Billing • Balance</div>
                      <div style="width:22px;"></div>
                    </div>
                    <div class="mock-content">
                      <div class="mock-panel">
                        <div class="mock-row sm"></div>
                        <div class="mock-row lg"></div>
                        <div class="mock-actions">
                          <div class="mock-button primary">Refresh Credits</div>
                          <div class="mock-button">View History</div>
                        </div>
                      </div>
                      <div class="mock-row md"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="legal-card">
          <h2>Notes</h2>
          <ul class="legal-list">
            <li>Referral codes are permanent and unique per account.</li>
            <li>Each account can apply a referral code once.</li>
            <li>If a user is already signed in on that browser, sign out first before entering a referral code.</li>
          </ul>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="footer-inner">
        <span>© 2026 WriterPro</span>
        <div class="footer-links">
          <a href="terms.html">Terms</a>
          <a href="privacy.html">Privacy</a>
        </div>
      </div>
    </footer>

    <script>
      const SUPABASE_URL = "https://vnzlaidwxgiaowhxtuvi.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuemxhaWR3eGdpYW93aHh0dXZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjcwNzksImV4cCI6MjA4NDQwMzA3OX0.AKiGX3xbgMKtUFYxHKEaAKwacFqmjPEsy56ofU1eDQQ";
      const referralCodeEl = document.getElementById("referral-code");
      const copyReferralBtn = document.getElementById("copy-referral");
      const referralStatus = document.getElementById("referral-status");
      const referralSignIn = document.getElementById("referral-signin");
      let session = null;

      function loadSession() {
        try {
          const raw = localStorage.getItem("wp_session");
          const fallback = sessionStorage.getItem("wp_session");
          if (raw || fallback) session = JSON.parse(raw || fallback);
        } catch {
          session = null;
        }
      }

      function getAccessToken() {
        return session && session.access_token ? session.access_token : "";
      }

      function getRefreshToken() {
        return session && session.refresh_token ? session.refresh_token : "";
      }

      function hasSessionToken() {
        return !!getAccessToken();
      }

      async function supabaseRequest(path, options) {
        const headers = options.headers || {};
        headers["apikey"] = SUPABASE_ANON_KEY;
        if (hasSessionToken()) headers["Authorization"] = `Bearer ${getAccessToken()}`;
        return fetch(`${SUPABASE_URL}${path}`, { ...options, headers });
      }

      async function refreshSession() {
        if (!getRefreshToken()) return false;
        try {
          const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=refresh_token`, {
            method: "POST",
            headers: { "Content-Type": "application/json", apikey: SUPABASE_ANON_KEY },
            body: JSON.stringify({ refresh_token: getRefreshToken() })
          });
          if (!res.ok) return false;
          const next = await res.json();
          if (!next || !next.access_token) return false;
          session = next;
          try {
            const serialized = JSON.stringify(next);
            localStorage.setItem("wp_session", serialized);
            sessionStorage.setItem("wp_session", serialized);
            window.name = `wp_session:${serialized}`;
          } catch {}
          return true;
        } catch {
          return false;
        }
      }

      async function getUser() {
        if (!hasSessionToken()) return null;
        try {
          const res = await supabaseRequest("/auth/v1/user", { method: "GET" });
          if (res.ok) return await res.json();
          if (res.status === 401) {
            const refreshed = await refreshSession();
            if (!refreshed) return null;
            const retry = await supabaseRequest("/auth/v1/user", { method: "GET" });
            if (retry.ok) return await retry.json();
          }
          return null;
        } catch {
          return null;
        }
      }

      async function loadReferralCode() {
        referralStatus.textContent = "";
        referralSignIn.style.display = "none";

        loadSession();
        if (!hasSessionToken()) {
          referralStatus.textContent = "Sign in to load your referral code.";
          referralSignIn.style.display = "inline-flex";
          return;
        }

        const user = await getUser();
        const userId = user && user.id ? user.id : "";
        if (!userId) {
          referralStatus.textContent = "Session expired. Please sign in again.";
          referralSignIn.style.display = "inline-flex";
          return;
        }

        try {
          const res = await supabaseRequest(`/rest/v1/profiles?id=eq.${userId}&select=referral_code`, { method: "GET" });
          if (!res.ok) {
            referralStatus.textContent = "Could not load referral code.";
            return;
          }
          const rows = await res.json();
          const code = rows && rows[0] && rows[0].referral_code ? rows[0].referral_code : "";
          if (!code) {
            referralStatus.textContent = "Referral code not found for this account yet. Refresh and try again.";
            return;
          }
          referralCodeEl.textContent = code;
        } catch {
          referralStatus.textContent = "Could not load referral code.";
        }
      }

      function navigateWithFade(url) {
        document.body.classList.add("page-exit");
        setTimeout(() => { window.location.href = url; }, 240);
      }

      document.querySelectorAll(".page-link").forEach((link) => {
        link.addEventListener("click", (event) => {
          const href = link.getAttribute("href") || "";
          if (href.startsWith("#")) return;
          event.preventDefault();
          navigateWithFade(href);
        });
      });

      copyReferralBtn.addEventListener("click", async () => {
        const code = (referralCodeEl.textContent || "").trim();
        if (!code || code === "—") {
          referralStatus.textContent = "Sign in to copy your referral code.";
          referralSignIn.style.display = "inline-flex";
          return;
        }
        try {
          await navigator.clipboard.writeText(code);
          referralStatus.textContent = "Copied referral code.";
          setTimeout(() => { if (referralStatus.textContent === "Copied referral code.") referralStatus.textContent = ""; }, 1200);
        } catch {
          referralStatus.textContent = "Copy failed. Select the code and copy it manually.";
        }
      });

      loadReferralCode();
    </script>
  </body>
</html>
