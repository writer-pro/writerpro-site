<!doctype html>
<html lang="en">
  <head>

    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
    <link rel="icon" type="image/png" sizes="64x64" href="favicon-64.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="favicon-512.png">

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Writer Pro — Sign In</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="page-enter">
    <header class="hero">
      <nav class="nav">
        <a class="logo" href="index.html">WRITER PRO</a>
        <div class="nav-actions">
          <a class="btn btn-outline page-link" href="index.html">HOME</a>
          <a class="btn btn-outline page-link" href="features.html">FEATURES</a>
          <a class="btn btn-outline page-link" href="pricing.html">PRICING</a>
          <a class="btn btn-outline page-link" href="support.html">SUPPORT</a>
          <a class="btn btn-outline page-link" href="download.html">DOWNLOAD</a>
        </div>
      </nav>

      <div class="hero-grid">
        <div class="hero-copy">
          <h1>SIGN IN</h1>
          <p class="subtitle">Log in first, then manage credits on the billing page.</p>
        </div>
      </div>
    </header>

    <section class="section" id="account">
      <div class="account-grid account-grid-single">
        <div class="card">
          <h3>ACCOUNT ACCESS</h3>
          <p>Use the same email you use on the Mac app.</p>
          <div class="form-stack">
            <input class="input" id="email" type="email" placeholder="Email" autocomplete="email" />
            <input class="input" id="password" type="password" placeholder="Password" autocomplete="current-password" />
            <input class="input" id="referral" type="text" placeholder="Referral code (optional)" />
            <button class="btn btn-primary" id="login">
              <span>Sign In</span>
              <span class="mini-spinner" id="auth-spinner" aria-hidden="true"></span>
            </button>
            <button class="btn btn-outline" id="signup">Create Account</button>
            <p class="notice" id="auth-status"></p>
          </div>
        </div>
      </div>
    </section>

    <div class="onboarding-overlay" id="onboarding-overlay" aria-hidden="true">
      <div class="onboarding-card">
        <div class="onboarding-head">
          <h3>Tell us about your workflow</h3>
          <p class="subtle">Personalize Writer Pro from day one.</p>
        </div>
        <form class="onboarding-form" id="onboarding-form">
          <div class="two-col">
            <label class="input">
              <span>Primary role</span>
              <select id="onb-role" required>
                <option value="" disabled selected>Select one</option>
                <option value="high_school">High school student</option>
                <option value="college">College student</option>
                <option value="university">University student</option>
                <option value="graduate">Graduate / post-grad</option>
                <option value="workforce">Workforce / professional</option>
                <option value="educator">Educator</option>
                <option value="other">Other</option>
              </select>
            </label>
            <label class="input">
              <span>Primary focus</span>
              <select id="onb-focus" required>
                <option value="" disabled selected>Select one</option>
                <option value="essays">Essays</option>
                <option value="research">Research papers</option>
                <option value="study">Study / flashcards</option>
                <option value="test_prep">Test prep</option>
                <option value="work_docs">Work documents</option>
                <option value="creative">Creative writing</option>
              </select>
            </label>
          </div>

          <label class="input">
            <span>Subjects (select all that apply)</span>
            <div class="chip-grid" id="onb-subjects">
              <button type="button" class="chip">English</button>
              <button type="button" class="chip">History</button>
              <button type="button" class="chip">Science</button>
              <button type="button" class="chip">Math</button>
              <button type="button" class="chip">Business</button>
              <button type="button" class="chip">Computer Science</button>
              <button type="button" class="chip">Languages</button>
              <button type="button" class="chip">Other</button>
            </div>
          </label>

          <div class="two-col">
            <label class="input">
              <span>Typical deadline</span>
              <select id="onb-deadline" required>
                <option value="" disabled selected>Select one</option>
                <option value="same_day">Same day</option>
                <option value="few_days">Few days</option>
                <option value="week_plus">A week+</option>
              </select>
            </label>
            <label class="input">
              <span>Writing volume / week</span>
              <select id="onb-volume" required>
                <option value="" disabled selected>Select one</option>
                <option value="light">Light (1–2 tasks)</option>
                <option value="moderate">Moderate (3–5 tasks)</option>
                <option value="heavy">Heavy (6+ tasks)</option>
              </select>
            </label>
          </div>

          <div class="two-col">
            <label class="input">
              <span>Preferred tone</span>
              <select id="onb-tone" required>
                <option value="" disabled selected>Select one</option>
                <option value="formal">Formal / academic</option>
                <option value="balanced">Balanced</option>
                <option value="conversational">Conversational</option>
              </select>
            </label>
            <label class="input">
              <span>AI comfort level</span>
              <select id="onb-ai" required>
                <option value="" disabled selected>Select one</option>
                <option value="low">Low — I want heavy control</option>
                <option value="medium">Medium — guide me</option>
                <option value="high">High — auto-suggestions ok</option>
              </select>
            </label>
          </div>

          <label class="input">
            <span>Primary device</span>
            <div class="chip-grid" id="onb-device">
              <button type="button" class="chip">MacBook</button>
              <button type="button" class="chip">iMac</button>
              <button type="button" class="chip">Mac mini</button>
              <button type="button" class="chip">Other</button>
            </div>
          </label>

          <div class="cta-row">
            <button class="btn btn-primary" id="onb-submit" type="submit">Finish Setup</button>
            <span class="notice" id="onb-status"></span>
          </div>
        </form>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-links">
        <a href="terms.html">Terms</a>
        <a href="privacy.html">Privacy</a>
      </div>
    </footer>

    <script>
      const SUPABASE_URL = "https://vnzlaidwxgiaowhxtuvi.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuemxhaWR3eGdpYW93aHh0dXZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjcwNzksImV4cCI6MjA4NDQwMzA3OX0.AKiGX3xbgMKtUFYxHKEaAKwacFqmjPEsy56ofU1eDQQ";

      const emailEl = document.getElementById("email");
      const passwordEl = document.getElementById("password");
      const referralEl = document.getElementById("referral");
      const authStatus = document.getElementById("auth-status");
      const authSpinner = document.getElementById("auth-spinner");
      const loginBtn = document.getElementById("login");
      const signupBtn = document.getElementById("signup");
      const onboardingOverlay = document.getElementById("onboarding-overlay");
      const onboardingForm = document.getElementById("onboarding-form");
      const onboardingStatus = document.getElementById("onb-status");
      const onboardingSubmit = document.getElementById("onb-submit");

      let session = null;
      function hasSessionToken() {
        return !!(session && session.access_token);
      }

      function storeSession(next) {
        session = next;
        try {
          if (next) {
            const serialized = JSON.stringify(next);
            localStorage.setItem("wp_session", serialized);
            sessionStorage.setItem("wp_session", serialized);
            window.name = `wp_session:${serialized}`;
          } else {
            localStorage.removeItem("wp_session");
            sessionStorage.removeItem("wp_session");
            if (window.name && window.name.startsWith("wp_session:")) {
              window.name = "";
            }
          }
        } catch {}
      }

      function loadSession() {
        try {
          const raw = localStorage.getItem("wp_session");
          const fallback = sessionStorage.getItem("wp_session");
          if (raw || fallback) session = JSON.parse(raw || fallback);
        } catch {
          session = null;
        }
      }

      function updateSessionUI() {
        // Sign-in page should redirect if already signed in.
      }

      async function supabaseRequest(path, options) {
        const headers = options.headers || {};
        headers["apikey"] = SUPABASE_ANON_KEY;
        if (hasSessionToken()) headers["Authorization"] = `Bearer ${session.access_token}`;
        return fetch(`${SUPABASE_URL}${path}`, { ...options, headers });
      }

      function setAuthLoading(isLoading) {
        authSpinner.classList.toggle("active", isLoading);
        loginBtn.classList.toggle("is-loading", isLoading);
        loginBtn.disabled = isLoading;
        signupBtn.disabled = isLoading;
        const loginLabel = loginBtn.querySelector("span");
        if (isLoading) {
          if (loginLabel) loginLabel.textContent = "Signing In...";
        } else {
          if (loginLabel) loginLabel.textContent = "Sign In";
        }
      }

      function goToBilling() {
        const params = new URLSearchParams(window.location.search);
        const next = params.get("next");
        const baseTarget = next && next.trim().length > 0 ? next : `billing.html?v=${Date.now()}`;
        const tokenHash = buildTokenHash();
        const target = tokenHash ? appendHash(baseTarget, tokenHash) : baseTarget;
        navigateWithFade(target);
      }

      function buildTokenHash() {
        if (!hasSessionToken()) return "";
        const parts = [];
        if (session.access_token) parts.push(`access_token=${encodeURIComponent(session.access_token)}`);
        if (session.refresh_token) parts.push(`refresh_token=${encodeURIComponent(session.refresh_token)}`);
        if (session.expires_at) parts.push(`expires_at=${encodeURIComponent(session.expires_at)}`);
        if (session.token_type) parts.push(`token_type=${encodeURIComponent(session.token_type)}`);
        return parts.join("&");
      }

      function appendHash(url, hash) {
        if (!hash) return url;
        if (url.indexOf("#") >= 0) {
          return `${url}&${hash}`;
        }
        return `${url}#${hash}`;
      }

      async function signIn() {
        const email = emailEl.value.trim();
        const password = passwordEl.value;
        if (!email || !password) {
          authStatus.textContent = "Enter email and password.";
          return;
        }
        if (!email.includes("@")) {
          authStatus.textContent = "Enter a valid email address.";
          return;
        }
        const referralCode = referralEl.value.trim();
        if (referralCode) localStorage.setItem("wp_referral_pending", referralCode);
        setAuthLoading(true);
        authStatus.textContent = "Signing in...";
        try {
          const res = await supabaseRequest("/auth/v1/token?grant_type=password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
          });
          if (!res.ok) {
            let detail = "";
            try {
              const payload = await res.json();
              detail = (payload && (payload.error_description || payload.msg || payload.error)) || "";
            } catch {}
            authStatus.textContent = detail ? `Sign in failed: ${detail}` : "Sign in failed.";
            return;
          }
          storeSession(await res.json());
          if (!hasSessionToken()) {
            authStatus.textContent = "Sign in failed: invalid session response.";
            return;
          }
          updateSessionUI();
          authStatus.textContent = "Signed in. Checking your profile...";
          await afterAuthSuccess();
        } catch (error) {
          authStatus.textContent = `Sign in failed: ${(error && error.message) || "network error"}`;
        } finally {
          setAuthLoading(false);
        }
      }

      async function signUp() {
        setAuthLoading(true);
        authStatus.textContent = "Creating account...";
        try {
          const referralCode = referralEl.value.trim();
          if (referralCode) localStorage.setItem("wp_referral_pending", referralCode);
          const res = await supabaseRequest("/auth/v1/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: emailEl.value, password: passwordEl.value })
          });
          authStatus.textContent = res.ok ? "Account created. Check your email." : "Sign up failed.";
        } finally {
          setAuthLoading(false);
        }
      }

      function toggleOnboarding(show) {
        onboardingOverlay.classList.toggle("active", show);
        onboardingOverlay.setAttribute("aria-hidden", show ? "false" : "true");
      }

      function collectChips(containerId) {
        return Array.from(document.querySelectorAll(`#${containerId} .chip.active`)).map((chip) =>
          chip.textContent.trim()
        );
      }

      document.querySelectorAll(".chip").forEach((chip) => {
        chip.addEventListener("click", () => chip.classList.toggle("active"));
      });

      async function fetchProfile() {
        const userRes = await supabaseRequest("/auth/v1/user", { method: "GET" });
        if (!userRes.ok) return null;
        const user = await userRes.json();
        const userId = user?.id;
        if (!userId) return null;

        const profileRes = await supabaseRequest(`/rest/v1/profiles?id=eq.${userId}&select=onboarding_completed`, { method: "GET" });
        if (!profileRes.ok) return { onboarding_completed: false };
        const rows = await profileRes.json();
        return rows && rows.length > 0 ? rows[0] : { onboarding_completed: false };
      }

      async function applyReferralIfNeeded() {
        const code = (localStorage.getItem("wp_referral_pending") || "").trim();
        if (!code) return;
        try {
          const res = await fetch("https://vnzlaidwxgiaowhxtuvi.functions.supabase.co/apply-referral", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${session.access_token}`
            },
            body: JSON.stringify({ code })
          });
          if (res.ok) {
            localStorage.removeItem("wp_referral_pending");
          }
        } catch {}
      }

      async function afterAuthSuccess() {
        const profile = await fetchProfile();
        if (profile && profile.onboarding_completed) {
          await applyReferralIfNeeded();
          authStatus.textContent = "Signed in. Redirecting to dashboard...";
          goToBilling();
          return;
        }
        toggleOnboarding(true);
      }

      onboardingForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        onboardingStatus.textContent = "Saving...";
        onboardingSubmit.disabled = true;

        const payload = {
          role: document.getElementById("onb-role").value,
          focus: document.getElementById("onb-focus").value,
          subjects: collectChips("onb-subjects"),
          deadline: document.getElementById("onb-deadline").value,
          volume: document.getElementById("onb-volume").value,
          tone: document.getElementById("onb-tone").value,
          ai_comfort: document.getElementById("onb-ai").value,
          devices: collectChips("onb-device")
        };

        try {
          const res = await fetch("https://vnzlaidwxgiaowhxtuvi.functions.supabase.co/onboarding-submit", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${session.access_token}`
            },
            body: JSON.stringify({ data: payload })
          });
          if (!res.ok) {
            const text = await res.text();
            onboardingStatus.textContent = `Save failed: ${text}`;
            return;
          }
          await applyReferralIfNeeded();
          onboardingStatus.textContent = "Saved! Redirecting...";
          toggleOnboarding(false);
          goToBilling();
        } catch (error) {
          onboardingStatus.textContent = `Save failed: ${error.message || "network error"}`;
        } finally {
          onboardingSubmit.disabled = false;
        }
      });


      function navigateWithFade(url) {
        document.body.classList.add("page-exit");
        setTimeout(() => { window.location.href = url; }, 240);
      }

      document.querySelectorAll(".page-link").forEach((link) => {
        link.addEventListener("click", (event) => {
          const href = link.getAttribute("href") || "";
          if (href.startsWith("#")) return;
          event.preventDefault();
          navigateWithFade(href);
        });
      });

      loginBtn.addEventListener("click", (event) => {
        event.preventDefault();
        signIn();
      });
      signupBtn.addEventListener("click", signUp);
      passwordEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter") signIn();
      });
      emailEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter") signIn();
      });

      loadSession();
      updateSessionUI();
      const params = new URLSearchParams(window.location.search);
      if (params.get("signed_out") === "1") {
        authStatus.textContent = "Signed out. Please sign in again.";
      }
      if (hasSessionToken()) {
        afterAuthSuccess();
      }
    </script>
  </body>
</html>
