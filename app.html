<!doctype html>
<html lang="en">
  <head>

    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
    <link rel="icon" type="image/png" sizes="64x64" href="favicon-64.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="favicon-512.png">

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Writer Pro ‚Äî Sign In</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="page-enter">
    <header class="hero">
      <nav class="nav">
        <a class="logo" href="index.html">WRITER PRO</a>
        <div class="nav-actions">
          <a class="btn btn-outline page-link" href="index.html">HOME</a>
          <a class="btn btn-outline page-link" href="features.html">FEATURES</a>
          <a class="btn btn-outline page-link" href="pricing.html">PRICING</a>
          <a class="btn btn-outline page-link" href="support.html">SUPPORT</a>
          <a class="btn btn-outline page-link" href="download.html">DOWNLOAD</a>
        </div>
      </nav>

      <div class="hero-grid">
        <div class="hero-copy">
          <h1>SIGN IN</h1>
          <p class="subtitle">Log in first, then manage credits on the billing page.</p>
        </div>
      </div>
    </header>

    <section class="section" id="account">
      <div class="account-grid account-grid-single">
        <div class="card">
          <h3>ACCOUNT ACCESS</h3>
          <p>Use the same email you use on the Mac app.</p>
          <div class="auth-tabs">
            <button class="btn btn-outline is-active" id="tab-signin" type="button">Sign In</button>
            <button class="btn btn-outline" id="tab-signup" type="button">Create Account</button>
          </div>
          <div class="form-stack">
            <div class="two-col" id="signup-names">
              <input class="input" id="first-name" type="text" placeholder="First name" autocomplete="given-name" />
              <input class="input" id="last-name" type="text" placeholder="Last name" autocomplete="family-name" />
            </div>
            <input class="input" id="email" type="email" placeholder="Email" autocomplete="email" />
            <input class="input" id="password" type="password" placeholder="Password" autocomplete="current-password" />
            <input class="input" id="password-confirm" type="password" placeholder="Confirm password" autocomplete="new-password" />
            <button class="btn btn-primary" id="login">
              <span>Sign In</span>
              <span class="mini-spinner" id="auth-spinner" aria-hidden="true"></span>
            </button>
            <button class="btn btn-outline" id="signup">Create Account</button>
            <p class="notice" id="auth-status"></p>
          </div>
        </div>
      </div>
    </section>

    <div class="onboarding-overlay" id="onboarding-overlay" aria-hidden="true">
      <div class="onboarding-card">
        <div class="onboarding-head">
          <div>
            <h3>Tell us about your workflow</h3>
            <p class="subtle">Personalize Writer Pro from day one.</p>
          </div>
          <button class="btn btn-outline btn-icon" id="onb-close" type="button" aria-label="Exit setup">
            <span aria-hidden="true">‚úï</span>
          </button>
        </div>
        <form class="onboarding-form" id="onboarding-form">
          <div class="onboarding-progress">
            <div class="onboarding-progress-bar" id="onb-progress"></div>
          </div>
          <div class="onboarding-step">
            <div class="onboarding-step-count" id="onb-step-count"></div>
            <h4 id="onb-question"></h4>
            <div class="onboarding-options" id="onb-options"></div>
            <div class="onboarding-input" id="onb-input"></div>
          </div>
          <div class="onboarding-actions">
            <button class="btn btn-outline" id="onb-back" type="button">Back</button>
            <button class="btn btn-outline" id="onb-skip" type="button">Skip</button>
            <button class="btn btn-primary btn-lg" id="onb-next" type="button">Next Question</button>
            <button class="btn btn-primary btn-lg" id="onb-submit" type="submit">Finish Setup</button>
          </div>
          <span class="notice" id="onb-status"></span>
        </form>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-links">
        <a href="terms.html">Terms</a>
        <a href="privacy.html">Privacy</a>
      </div>
    </footer>

    <script>
      const SUPABASE_URL = "https://vnzlaidwxgiaowhxtuvi.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuemxhaWR3eGdpYW93aHh0dXZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjcwNzksImV4cCI6MjA4NDQwMzA3OX0.AKiGX3xbgMKtUFYxHKEaAKwacFqmjPEsy56ofU1eDQQ";

      const emailEl = document.getElementById("email");
      const passwordEl = document.getElementById("password");
      const passwordConfirmEl = document.getElementById("password-confirm");
      const firstNameEl = document.getElementById("first-name");
      const lastNameEl = document.getElementById("last-name");
      const signupNamesRow = document.getElementById("signup-names");
      const tabSignIn = document.getElementById("tab-signin");
      const tabSignUp = document.getElementById("tab-signup");
      const authStatus = document.getElementById("auth-status");
      const authSpinner = document.getElementById("auth-spinner");
      const loginBtn = document.getElementById("login");
      const signupBtn = document.getElementById("signup");
      const onboardingOverlay = document.getElementById("onboarding-overlay");
      const onboardingForm = document.getElementById("onboarding-form");
      const onboardingStatus = document.getElementById("onb-status");
      const onboardingSubmit = document.getElementById("onb-submit");
      const onboardingProgress = document.getElementById("onb-progress");
      const onboardingStepCount = document.getElementById("onb-step-count");
      const onboardingQuestion = document.getElementById("onb-question");
      const onboardingOptions = document.getElementById("onb-options");
      const onboardingInput = document.getElementById("onb-input");
      const onboardingBack = document.getElementById("onb-back");
      const onboardingNext = document.getElementById("onb-next");
      const onboardingSkip = document.getElementById("onb-skip");
      const onboardingClose = document.getElementById("onb-close");

      const onboardingSteps = [
        {
          id: "role",
          question: "What best describes you?",
          type: "single",
          options: [
            { icon: "üéì", label: "High school student", value: "high_school" },
            { icon: "üìö", label: "College student", value: "college" },
            { icon: "üèõÔ∏è", label: "University student", value: "university" },
            { icon: "üß™", label: "Graduate / post-grad", value: "graduate" },
            { icon: "üíº", label: "Workforce / professional", value: "workforce" },
            { icon: "üßë‚Äçüè´", label: "Educator", value: "educator" }
          ]
        },
        {
          id: "goal",
          question: "What do you primarily want to create?",
          type: "single",
          options: [
            { icon: "üìù", label: "Essays", value: "essays" },
            { icon: "üî¨", label: "Research papers", value: "research" },
            { icon: "üìñ", label: "Study materials", value: "study" },
            { icon: "üß†", label: "Test prep", value: "test_prep" },
            { icon: "üìÑ", label: "Work documents", value: "work_docs" },
            { icon: "‚úçÔ∏è", label: "Creative writing", value: "creative" }
          ]
        },
        {
          id: "subjects",
          question: "Which subjects matter most right now? (Select all)",
          type: "multi",
          options: [
            { icon: "üìò", label: "English", value: "english" },
            { icon: "üè∫", label: "History", value: "history" },
            { icon: "üß¨", label: "Science", value: "science" },
            { icon: "‚ûó", label: "Math", value: "math" },
            { icon: "üìä", label: "Business", value: "business" },
            { icon: "üíª", label: "Computer Science", value: "cs" },
            { icon: "üåç", label: "Languages", value: "languages" },
            { icon: "‚ú®", label: "Other", value: "other" }
          ]
        },
        {
          id: "deadline",
          question: "How soon are your typical deadlines?",
          type: "single",
          options: [
            { icon: "‚ö°", label: "Same day", value: "same_day" },
            { icon: "‚è±Ô∏è", label: "Few days", value: "few_days" },
            { icon: "üóìÔ∏è", label: "A week or more", value: "week_plus" }
          ]
        },
        {
          id: "volume",
          question: "How much writing or studying do you do each week?",
          type: "single",
          options: [
            { icon: "üß©", label: "Light (1‚Äì2 tasks)", value: "light" },
            { icon: "üìö", label: "Moderate (3‚Äì5 tasks)", value: "moderate" },
            { icon: "üèÉ", label: "Heavy (6+ tasks)", value: "heavy" }
          ]
        },
        {
          id: "tone",
          question: "Preferred writing tone?",
          type: "single",
          options: [
            { icon: "üéì", label: "Formal / academic", value: "formal" },
            { icon: "‚öñÔ∏è", label: "Balanced", value: "balanced" },
            { icon: "üí¨", label: "Conversational", value: "conversational" }
          ]
        },
        {
          id: "ai_comfort",
          question: "How comfortable are you with AI suggestions?",
          type: "single",
          options: [
            { icon: "üõ°Ô∏è", label: "Low ‚Äî I want heavy control", value: "low" },
            { icon: "ü§ù", label: "Medium ‚Äî guide me", value: "medium" },
            { icon: "üöÄ", label: "High ‚Äî auto-suggestions ok", value: "high" }
          ]
        },
        {
          id: "device",
          question: "Primary device",
          type: "single",
          options: [
            { icon: "üíª", label: "MacBook", value: "macbook" },
            { icon: "üñ•Ô∏è", label: "iMac", value: "imac" },
            { icon: "üß±", label: "Mac mini", value: "macmini" },
            { icon: "üß©", label: "Other", value: "other" }
          ]
        },
        {
          id: "referral",
          question: "Have a referral code? (Optional)",
          type: "text",
          placeholder: "Enter referral code"
        }
      ];
      let onboardingIndex = 0;
      const onboardingAnswers = {};

      let session = null;
      function parseHashSession() {
        const hash = window.location.hash || "";
        if (!hash || hash.length < 2) return;
        const params = new URLSearchParams(hash.substring(1));
        const accessToken = params.get("access_token");
        if (!accessToken) return;
        const refreshToken = params.get("refresh_token") || "";
        const expiresAt = params.get("expires_at");
        const tokenType = params.get("token_type") || "bearer";
        const nextSession = {
          access_token: accessToken,
          refresh_token: refreshToken,
          expires_at: expiresAt ? parseInt(expiresAt, 10) : undefined,
          token_type: tokenType
        };
        storeSession(nextSession);
        try {
          history.replaceState({}, document.title, window.location.pathname + window.location.search);
        } catch {}
      }
      function normalizeSession(next) {
        if (!next) return null;
        if (next.session && next.session.access_token) return next.session;
        return next;
      }
      function getAccessToken() {
        return session && session.access_token ? session.access_token : "";
      }
      function getRefreshToken() {
        return session && session.refresh_token ? session.refresh_token : "";
      }
      function hasSessionToken() {
        return !!getAccessToken();
      }

      function storeSession(next) {
        session = normalizeSession(next);
        try {
          if (session) {
            const serialized = JSON.stringify(session);
            localStorage.setItem("wp_session", serialized);
            sessionStorage.setItem("wp_session", serialized);
            window.name = `wp_session:${serialized}`;
          } else {
            localStorage.removeItem("wp_session");
            sessionStorage.removeItem("wp_session");
            if (window.name && window.name.startsWith("wp_session:")) {
              window.name = "";
            }
          }
        } catch {}
      }

      function clearSession() {
        storeSession(null);
      }

      function onboardingDoneKey(userId) {
        return `wp_onboarding_done_${userId || "unknown"}`;
      }

      function markOnboardingDone(userId) {
        if (!userId) return;
        try {
          localStorage.setItem(onboardingDoneKey(userId), "1");
        } catch {}
      }

      function hasOnboardingDoneFlag(userId) {
        if (!userId) return false;
        try {
          return localStorage.getItem(onboardingDoneKey(userId)) === "1";
        } catch {
          return false;
        }
      }

      function pendingOnboardingKey(userId) {
        return `wp_onboarding_pending_${userId || "unknown"}`;
      }

      function setPendingOnboarding(userId, data) {
        if (!userId) return;
        try {
          localStorage.setItem(pendingOnboardingKey(userId), JSON.stringify(data || {}));
        } catch {}
      }

      function getPendingOnboarding(userId) {
        if (!userId) return null;
        try {
          const raw = localStorage.getItem(pendingOnboardingKey(userId));
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }

      function clearPendingOnboarding(userId) {
        if (!userId) return;
        try {
          localStorage.removeItem(pendingOnboardingKey(userId));
        } catch {}
      }

      function setOnboardingUserId(id) {
        try {
          if (id) {
            localStorage.setItem("wp_onboarding_user_id", id);
          } else {
            localStorage.removeItem("wp_onboarding_user_id");
          }
        } catch {}
      }

      function getOnboardingUserId() {
        try {
          return localStorage.getItem("wp_onboarding_user_id") || "";
        } catch {
          return "";
        }
      }

      function loadSession() {
        try {
          const raw = localStorage.getItem("wp_session");
          const fallback = sessionStorage.getItem("wp_session");
          if (raw || fallback) session = normalizeSession(JSON.parse(raw || fallback));
        } catch {
          session = null;
        }
      }

      async function ensureSessionReady() {
        loadSession();
        if (hasSessionToken()) return true;
        if (getRefreshToken()) {
          return await refreshSession();
        }
        return false;
      }

      function updateSessionUI() {
        // Sign-in page should redirect if already signed in.
      }

      async function supabaseRequest(path, options) {
        const headers = options.headers || {};
        headers["apikey"] = SUPABASE_ANON_KEY;
        if (hasSessionToken()) headers["Authorization"] = `Bearer ${getAccessToken()}`;
        return fetch(`${SUPABASE_URL}${path}`, { ...options, headers });
      }

      async function refreshSession() {
        if (!session || !getRefreshToken()) return false;
        try {
          const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=refresh_token`, {
            method: "POST",
            headers: { "Content-Type": "application/json", apikey: SUPABASE_ANON_KEY },
            body: JSON.stringify({ refresh_token: getRefreshToken() })
          });
          if (!res.ok) return false;
          const next = await res.json();
          if (!next || !next.access_token) return false;
          storeSession(next);
          return true;
        } catch {
          return false;
        }
      }

      function setAuthLoading(isLoading) {
        authSpinner.classList.toggle("active", isLoading);
        loginBtn.classList.toggle("is-loading", isLoading);
        loginBtn.disabled = isLoading;
        signupBtn.disabled = isLoading;
        const loginLabel = loginBtn.querySelector("span");
        if (isLoading) {
          if (loginLabel) loginLabel.textContent = "Signing In...";
        } else {
          if (loginLabel) loginLabel.textContent = "Sign In";
        }
      }

      function setAuthMode(mode) {
        const isSignup = mode === "signup";
        tabSignIn.classList.toggle("is-active", !isSignup);
        tabSignUp.classList.toggle("is-active", isSignup);
        signupNamesRow.style.display = isSignup ? "grid" : "none";
        passwordConfirmEl.style.display = isSignup ? "block" : "none";
        loginBtn.style.display = isSignup ? "none" : "inline-flex";
        signupBtn.style.display = isSignup ? "inline-flex" : "none";
        passwordEl.setAttribute("autocomplete", isSignup ? "new-password" : "current-password");
        authStatus.textContent = "";
      }

      function goToBilling() {
        const params = new URLSearchParams(window.location.search);
        const next = params.get("next");
        const baseTarget = next && next.trim().length > 0 ? next : `billing.html?v=${Date.now()}`;
        const tokenHash = buildTokenHash();
        const target = tokenHash ? appendHash(baseTarget, tokenHash) : baseTarget;
        navigateWithFade(target);
      }

      function buildTokenHash() {
        if (!hasSessionToken()) return "";
        const parts = [];
        if (getAccessToken()) parts.push(`access_token=${encodeURIComponent(getAccessToken())}`);
        if (getRefreshToken()) parts.push(`refresh_token=${encodeURIComponent(getRefreshToken())}`);
        if (session && session.expires_at) parts.push(`expires_at=${encodeURIComponent(session.expires_at)}`);
        if (session && session.token_type) parts.push(`token_type=${encodeURIComponent(session.token_type)}`);
        return parts.join("&");
      }

      function appendHash(url, hash) {
        if (!hash) return url;
        if (url.indexOf("#") >= 0) {
          return `${url}&${hash}`;
        }
        return `${url}#${hash}`;
      }

      async function signIn() {
        const email = emailEl.value.trim();
        const password = passwordEl.value;
        if (!email || !password) {
          authStatus.textContent = "Enter email and password.";
          return;
        }
        if (!email.includes("@")) {
          authStatus.textContent = "Enter a valid email address.";
          return;
        }
        setAuthLoading(true);
        authStatus.textContent = "Signing in...";
        try {
          const res = await supabaseRequest("/auth/v1/token?grant_type=password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
          });
          if (!res.ok) {
            let detail = "";
            try {
              const payload = await res.json();
              detail = (payload && (payload.error_description || payload.msg || payload.error)) || "";
            } catch {}
            authStatus.textContent = detail ? `Sign in failed: ${detail}` : "Sign in failed.";
            return;
          }
          const payload = await res.json();
          if (!payload || !payload.access_token) {
            authStatus.textContent = "Sign in failed: invalid session response.";
            return;
          }
          storeSession(payload);
          if (!hasSessionToken()) {
            authStatus.textContent = "Sign in failed: invalid session response.";
            return;
          }
          updateSessionUI();
          authStatus.textContent = "Signing in...";
          await afterAuthSuccess();
        } catch (error) {
          authStatus.textContent = `Sign in failed: ${(error && error.message) || "network error"}`;
        } finally {
          setAuthLoading(false);
        }
      }

      async function signUp() {
        const email = emailEl.value.trim();
        const password = passwordEl.value;
        const confirm = passwordConfirmEl.value;
        const firstName = firstNameEl.value.trim();
        const lastName = lastNameEl.value.trim();
        if (!email || !password) {
          authStatus.textContent = "Enter email and password.";
          return;
        }
        if (!email.includes("@")) {
          authStatus.textContent = "Enter a valid email address.";
          return;
        }
        if (!firstName || !lastName) {
          authStatus.textContent = "Enter first and last name.";
          return;
        }
        if (password.length < 8) {
          authStatus.textContent = "Use a password with at least 8 characters.";
          return;
        }
        if (password !== confirm) {
          authStatus.textContent = "Passwords do not match.";
          return;
        }
        setAuthLoading(true);
        authStatus.textContent = "Creating account...";
        try {
          const res = await supabaseRequest("/auth/v1/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email,
              password,
              data: { first_name: firstName, last_name: lastName }
            })
          });
          let payload = null;
          try { payload = await res.json(); } catch {}
          if (!res.ok) {
            const detail = payload && (payload.error_description || payload.msg || payload.error);
            authStatus.textContent = detail ? `Sign up failed: ${detail}` : "Sign up failed.";
            return;
          }
          localStorage.setItem("wp_new_signup", "1");
          if (payload && payload.access_token) {
            storeSession(payload);
            authStatus.textContent = "Account created. Finishing setup...";
            await syncProfileFromAuth();
            await afterAuthSuccess();
          } else {
            authStatus.textContent = "Account created. Check your email to confirm, then sign in.";
          }
        } finally {
          setAuthLoading(false);
        }
      }

      function toggleOnboarding(show) {
        onboardingOverlay.classList.toggle("active", show);
        onboardingOverlay.setAttribute("aria-hidden", show ? "false" : "true");
        if (show) {
          resetOnboardingState();
        }
      }

      function resetOnboardingState() {
        onboardingIndex = 0;
        Object.keys(onboardingAnswers).forEach((key) => delete onboardingAnswers[key]);
        onboardingOptions.innerHTML = "";
        onboardingInput.innerHTML = "";
        onboardingStatus.textContent = "";
        renderStep();
      }

      function setStepButtons() {
        onboardingBack.style.display = onboardingIndex === 0 ? "none" : "inline-flex";
        onboardingNext.style.display = onboardingIndex < onboardingSteps.length - 1 ? "inline-flex" : "none";
        onboardingSubmit.style.display = onboardingIndex === onboardingSteps.length - 1 ? "inline-flex" : "none";
        onboardingSkip.style.display = onboardingSteps[onboardingIndex].id === "referral" ? "none" : "inline-flex";
      }

      function setProgress() {
        const progress = (onboardingIndex + 1) / onboardingSteps.length;
        onboardingProgress.style.width = `${Math.max(0, Math.min(1, progress)) * 100}%`;
        onboardingStepCount.textContent = `Step ${onboardingIndex + 1} of ${onboardingSteps.length}`;
      }

      function renderOptions(step) {
        onboardingOptions.innerHTML = "";
        onboardingInput.innerHTML = "";
        if (step.type === "text") {
          const input = document.createElement("input");
          input.className = "input";
          input.placeholder = step.placeholder || "";
          input.value = onboardingAnswers[step.id] || "";
          input.addEventListener("input", () => {
            onboardingAnswers[step.id] = input.value.trim();
          });
          onboardingInput.appendChild(input);
          return;
        }

        if (step.type === "multi") {
          const selectAll = document.createElement("button");
          selectAll.type = "button";
          selectAll.className = "onboarding-option select-all";
          selectAll.innerHTML = "<span class=\"option-icon\">‚úÖ</span><span>Select all</span>";
          selectAll.addEventListener("click", () => {
            onboardingAnswers[step.id] = step.options.map((opt) => opt.value);
            renderStep();
          });
          onboardingOptions.appendChild(selectAll);
        }

        step.options.forEach((opt) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "onboarding-option";
          const icon = document.createElement("span");
          icon.className = "option-icon";
          icon.textContent = opt.icon;
          const label = document.createElement("span");
          label.textContent = opt.label;
          btn.appendChild(icon);
          btn.appendChild(label);

          const current = onboardingAnswers[step.id];
          if (step.type === "single" && current === opt.value) btn.classList.add("active");
          if (step.type === "multi" && Array.isArray(current) && current.includes(opt.value)) btn.classList.add("active");

          btn.addEventListener("click", () => {
            if (step.type === "single") {
              onboardingAnswers[step.id] = opt.value;
              renderStep();
            } else {
              const existing = Array.isArray(onboardingAnswers[step.id]) ? onboardingAnswers[step.id] : [];
              if (existing.includes(opt.value)) {
                onboardingAnswers[step.id] = existing.filter((v) => v !== opt.value);
              } else {
                onboardingAnswers[step.id] = [...existing, opt.value];
              }
              renderStep();
            }
          });
          onboardingOptions.appendChild(btn);
        });
      }

      function renderStep() {
        const step = onboardingSteps[onboardingIndex];
        onboardingQuestion.textContent = step.question;
        renderOptions(step);
        setProgress();
        setStepButtons();
        const stepEl = document.querySelector(".onboarding-step");
        if (stepEl) {
          stepEl.classList.remove("animate");
          void stepEl.offsetWidth;
          stepEl.classList.add("animate");
        }
      }

      function canAdvance() {
        const step = onboardingSteps[onboardingIndex];
        const value = onboardingAnswers[step.id];
        if (step.type === "text") return true;
        if (step.type === "single") return !!value;
        if (step.type === "multi") return Array.isArray(value) && value.length > 0;
        return false;
      }

      onboardingBack.addEventListener("click", () => {
        onboardingStatus.textContent = "";
        onboardingIndex = Math.max(0, onboardingIndex - 1);
        renderStep();
      });

      onboardingNext.addEventListener("click", () => {
        if (!canAdvance()) {
          onboardingStatus.textContent = "Please select an option to continue.";
          return;
        }
        onboardingStatus.textContent = "";
        onboardingIndex = Math.min(onboardingSteps.length - 1, onboardingIndex + 1);
        renderStep();
      });

      onboardingSkip.addEventListener("click", () => {
        onboardingStatus.textContent = "";
        onboardingIndex = Math.min(onboardingSteps.length - 1, onboardingIndex + 1);
        renderStep();
      });

      onboardingOptions.addEventListener("click", () => {
        if (canAdvance() && onboardingIndex < onboardingSteps.length - 1) {
          onboardingNext.classList.add("pulse");
          setTimeout(() => onboardingNext.classList.remove("pulse"), 220);
        }
      });

      onboardingClose.addEventListener("click", () => {
        toggleOnboarding(false);
        clearSession();
        localStorage.removeItem("wp_new_signup");
        setOnboardingUserId("");
        authStatus.textContent = "Setup cancelled. Please sign in again.";
      });

      async function fetchProfile() {
        const userRes = await supabaseRequest("/auth/v1/user", { method: "GET" });
        if (!userRes.ok) return null;
        const user = await userRes.json();
        const userId = user?.id;
        if (!userId) return null;

        const profileRes = await supabaseRequest(`/rest/v1/profiles?id=eq.${userId}&select=onboarding_completed`, { method: "GET" });
        if (!profileRes.ok) return { onboarding_completed: false };
        const rows = await profileRes.json();
        const profile = rows && rows.length > 0 ? rows[0] : { onboarding_completed: false };
        return { ...profile, userId };
      }

      async function syncProfileFromAuth() {
        try {
          const userRes = await supabaseRequest("/auth/v1/user", { method: "GET" });
          if (!userRes.ok) return;
          const user = await userRes.json();
          if (!user?.id) return;
          const meta = user.user_metadata || {};
          const payload = {
            id: user.id,
            email: user.email || "",
            first_name: meta.first_name || "",
            last_name: meta.last_name || ""
          };
          await supabaseRequest("/rest/v1/profiles", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Prefer": "resolution=merge-duplicates"
            },
            body: JSON.stringify(payload)
          });
        } catch {}
      }

      async function applyReferralIfNeeded() {
        const code = (localStorage.getItem("wp_referral_pending") || "").trim();
        if (!code) return;
        try {
          const res = await fetch("https://vnzlaidwxgiaowhxtuvi.functions.supabase.co/apply-referral", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${getAccessToken()}`
            },
            body: JSON.stringify({ code })
          });
          if (res.ok) {
            localStorage.removeItem("wp_referral_pending");
          }
        } catch {}
      }

      async function validateReferral(code) {
        if (!code) return { ok: true };
        try {
          const res = await fetch("https://vnzlaidwxgiaowhxtuvi.functions.supabase.co/apply-referral", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${getAccessToken()}`
            },
            body: JSON.stringify({ code })
          });
          if (res.ok) {
            localStorage.removeItem("wp_referral_pending");
            return { ok: true };
          }
          if (res.status === 404) {
            return { ok: false, message: "Invalid referral code. Leave it blank if you don't have one." };
          }
          const text = await res.text();
          return { ok: false, message: text || "Referral validation failed." };
        } catch (error) {
          return { ok: false, message: error.message || "Referral validation failed." };
        }
      }

      async function afterAuthSuccess() {
        await syncProfileFromAuth();
        const profile = await fetchProfile();
        const newSignup = localStorage.getItem("wp_new_signup") === "1";
        const userId = profile?.userId || "";
        const pending = getPendingOnboarding(userId);
        if (profile && profile.onboarding_completed) {
          localStorage.removeItem("wp_new_signup");
          setOnboardingUserId("");
          clearPendingOnboarding(userId);
          await applyReferralIfNeeded();
          authStatus.textContent = "Signed in. Redirecting to dashboard...";
          goToBilling();
          return;
        }
        if (pending && profile && profile.onboarding_completed === false) {
          try {
            await ensureSessionReady();
            await fetch("https://vnzlaidwxgiaowhxtuvi.functions.supabase.co/onboarding-submit", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${getAccessToken()}`
              },
              body: JSON.stringify({ data: pending })
            });
            markOnboardingDone(userId);
            clearPendingOnboarding(userId);
          } catch {}
        }
        if (profile && profile.onboarding_completed === false && hasOnboardingDoneFlag(userId)) {
          localStorage.removeItem("wp_new_signup");
          setOnboardingUserId("");
          await applyReferralIfNeeded();
          authStatus.textContent = "Signed in. Redirecting to dashboard...";
          goToBilling();
          return;
        }
        if (profile && profile.onboarding_completed === false) {
          const allowedId = getOnboardingUserId();
          if (newSignup && profile.userId) {
            setOnboardingUserId(profile.userId);
            toggleOnboarding(true);
            return;
          }
          if (allowedId && profile.userId && allowedId === profile.userId) {
            toggleOnboarding(true);
            return;
          }
          toggleOnboarding(true);
          return;
        }
        if (newSignup) {
          toggleOnboarding(true);
        } else {
          authStatus.textContent = "Signed in. Redirecting to dashboard...";
          goToBilling();
        }
      }

      async function submitOnboarding(event) {
        event.preventDefault();
        await ensureSessionReady();
        onboardingStatus.textContent = "Saving...";
        onboardingSubmit.disabled = true;
        // All questions are optional; allow finishing without answers.
        const referralInput = (onboardingAnswers.referral || "").trim();
        if (referralInput) {
          const referralCheck = await validateReferral(referralInput);
          if (!referralCheck.ok) {
            onboardingStatus.textContent = referralCheck.message || "Invalid referral code.";
            onboardingSubmit.disabled = false;
            return;
          }
        }

        const payload = {
          role: onboardingAnswers.role || "",
          goal: onboardingAnswers.goal || "",
          subjects: onboardingAnswers.subjects || [],
          deadline: onboardingAnswers.deadline || "",
          volume: onboardingAnswers.volume || "",
          tone: onboardingAnswers.tone || "",
          ai_comfort: onboardingAnswers.ai_comfort || "",
          device: onboardingAnswers.device || ""
        };
        const userId = getOnboardingUserId();

        async function sendOnboarding() {
          await ensureSessionReady();
          if (!hasSessionToken()) {
            setPendingOnboarding(userId, payload);
            return { ok: false, status: 0, text: async () => "session missing" };
          }
          return fetch("https://vnzlaidwxgiaowhxtuvi.functions.supabase.co/onboarding-submit", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${getAccessToken()}`
            },
            body: JSON.stringify({ data: payload })
          });
        }

        async function confirmOnboardingSaved() {
          await ensureSessionReady();
          let profile = await fetchProfile();
          if (profile && profile.onboarding_completed) return true;
          const refreshed = await refreshSession();
          if (!refreshed) return false;
          profile = await fetchProfile();
          return !!(profile && profile.onboarding_completed);
        }

        try {
          let res = await sendOnboarding();
          if (!res.ok) {
            if (res.status === 401) {
              const refreshed = await refreshSession();
              if (refreshed) {
                onboardingStatus.textContent = "Session refreshed. Saving...";
                res = await sendOnboarding();
                if (res.ok) {
                  const confirmed = await confirmOnboardingSaved();
                  if (!confirmed) {
                    onboardingStatus.textContent = "We couldn't confirm your setup was saved. Please try again.";
                    onboardingSubmit.disabled = false;
                    return;
                  }
                  return finishOnboarding();
                }
              }
              setPendingOnboarding(userId, payload);
              return finishOnboarding();
            }
            const text = await res.text();
            setPendingOnboarding(userId, payload);
            return finishOnboarding();
          }
          const confirmed = await confirmOnboardingSaved();
          if (!confirmed) {
            setPendingOnboarding(userId, payload);
            return finishOnboarding();
          }
          return finishOnboarding();
        } catch (error) {
          setPendingOnboarding(userId, payload);
          return finishOnboarding();
        } finally {
          onboardingSubmit.disabled = false;
        }
      }

      async function finishOnboarding() {
        onboardingStatus.textContent = "Saved! Redirecting...";
        toggleOnboarding(false);
        localStorage.removeItem("wp_new_signup");
        markOnboardingDone(getOnboardingUserId());
        setOnboardingUserId("");
        window.location.href = "download.html";
      }

      onboardingForm.addEventListener("submit", submitOnboarding);


      function navigateWithFade(url) {
        document.body.classList.add("page-exit");
        setTimeout(() => { window.location.href = url; }, 240);
      }

      tabSignIn.addEventListener("click", () => setAuthMode("signin"));
      tabSignUp.addEventListener("click", () => setAuthMode("signup"));

      document.querySelectorAll(".page-link").forEach((link) => {
        link.addEventListener("click", (event) => {
          const href = link.getAttribute("href") || "";
          if (href.startsWith("#")) return;
          event.preventDefault();
          navigateWithFade(href);
        });
      });

      loginBtn.addEventListener("click", (event) => {
        event.preventDefault();
        signIn();
      });
      signupBtn.addEventListener("click", signUp);
      passwordEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter") signIn();
      });
      emailEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter") signIn();
      });

      parseHashSession();
      loadSession();
      setAuthMode("signin");
      updateSessionUI();
      const refParam = new URLSearchParams(window.location.search).get("ref");
      if (refParam) {
        localStorage.setItem("wp_referral_pending", refParam);
      }
      const params = new URLSearchParams(window.location.search);
      if (params.get("signed_out") === "1") {
        authStatus.textContent = "Signed out. Please sign in again.";
      }
      if (params.get("onboarding_done") === "1") {
        authStatus.textContent = "Setup complete. Please sign in.";
      }
      if (hasSessionToken()) {
        afterAuthSuccess();
      }
    </script>
  </body>
</html>
