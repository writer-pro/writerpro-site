<!doctype html>
<html lang="en">
  <head>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
    <link rel="icon" type="image/png" sizes="64x64" href="favicon-64.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="favicon-512.png">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Writer Pro — Earn Credits</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="legal-page page-enter">
    <header class="hero legal-hero">
      <nav class="nav">
        <a class="logo" href="index.html">WRITER PRO</a>
        <div class="nav-actions">
          <a class="btn btn-outline page-link" href="index.html">HOME</a>
          <a class="btn btn-outline page-link" href="billing.html">BILLING</a>
          <a class="btn btn-outline page-link" href="support.html">SUPPORT</a>
        </div>
      </nav>
      <div class="hero-grid legal-hero-grid">
        <div class="hero-copy legal-hero-copy">
          <h1>EARN CREDITS</h1>
          <p class="subtitle">Follow the steps below to earn credits with a one‑time code.</p>
        </div>
      </div>
    </header>

    <section class="section">
      <div class="legal-shell">
        <div class="legal-card">
          <h2>Referral credits</h2>
          <p class="subtle">Share your referral code. New users get +5 credits, and you get +5 credits for every signup.</p>
          <div class="referral-row" style="margin-top: 12px;">
            <div class="referral-label">Your referral code</div>
            <div class="referral-box">
              <span class="referral-code" id="referral-code">—</span>
              <button class="btn btn-outline btn-small" id="copy-referral" type="button">Copy</button>
            </div>
          </div>
          <div class="cta-row" style="margin-top: 12px;">
            <a class="btn btn-outline page-link" href="referral.html" id="referral-how" style="white-space:nowrap;">How it works</a>
            <a class="btn btn-primary page-link" href="app.html" id="referral-signin" style="display:none;white-space:nowrap;">Sign In</a>
          </div>
          <p class="notice" id="referral-status"></p>
        </div>

        <div class="legal-card">
          <h2>Earn credits (guide)</h2>
          <p class="subtle">Complete an offer, receive a code, and redeem it in Billing.</p>
          <div class="legal-note">Codes are one‑time and expire. Redeem quickly to avoid losing the credit.</div>
        </div>

        <div class="legal-card">
          <h2>Step‑by‑step</h2>
          <div class="step-list">
            <div class="step-row">
              <div class="step-index">1</div>
              <div class="step-body">
                <h3>Sign in</h3>
                <p>Sign in to the account you want to credit. Make sure you’re on the correct email before you continue.</p>
                <div class="step-media">
                  <div class="mock-window">
                    <div class="mock-topbar">
                      <div class="mock-dots">
                        <span class="mock-dot red"></span>
                        <span class="mock-dot yellow"></span>
                        <span class="mock-dot green"></span>
                      </div>
                      <div class="mock-title">Writer Pro • Sign In</div>
                      <div style="width:22px;"></div>
                    </div>
                    <div class="mock-content">
                      <div class="mock-row md"></div>
                      <div class="mock-row xs"></div>
                      <div class="mock-input"></div>
                      <div class="mock-input"></div>
                      <div class="mock-row xs"></div>
                      <div class="mock-actions">
                        <div class="mock-button primary">Sign In</div>
                        <div class="mock-button">Create Account</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="step-row">
              <div class="step-index">2</div>
              <div class="step-body">
                <h3>Open the earn credits flow</h3>
                <p>Open the earn‑credits flow and complete the offer steps. When you finish, you’ll see a redemption code.</p>
                <div class="step-media">
                  <div class="mock-window">
                    <div class="mock-topbar">
                      <div class="mock-dots">
                        <span class="mock-dot red"></span>
                        <span class="mock-dot yellow"></span>
                        <span class="mock-dot green"></span>
                      </div>
                      <div class="mock-title">Unlock • Earn Credits</div>
                      <div style="width:22px;"></div>
                    </div>
                    <div class="mock-content">
                      <div class="mock-panel">
                        <div class="mock-row lg"></div>
                        <div class="mock-row sm"></div>
                        <div class="mock-progress"><span></span></div>
                        <div class="mock-row xs"></div>
                      </div>
                      <div class="mock-grid-2">
                        <div class="mock-panel">
                          <div class="mock-pill active"><span class="dot"></span> Step 1 complete</div>
                          <div class="mock-pill"><span class="dot"></span> Step 2 in progress</div>
                          <div class="mock-row xs"></div>
                        </div>
                        <div class="mock-panel">
                          <div class="mock-row md"></div>
                          <div class="mock-row xs"></div>
                          <div class="mock-actions">
                            <div class="mock-button primary">Continue</div>
                            <div class="mock-button">Back</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="step-row">
              <div class="step-index">3</div>
              <div class="step-body">
                <h3>Copy your redemption code</h3>
                <p>Copy the code exactly as shown. Codes are one‑time and expire, so redeem it quickly.</p>
                <div class="step-media">
                  <div class="mock-window">
                    <div class="mock-topbar">
                      <div class="mock-dots">
                        <span class="mock-dot red"></span>
                        <span class="mock-dot yellow"></span>
                        <span class="mock-dot green"></span>
                      </div>
                      <div class="mock-title">Unlocked • Reward Code</div>
                      <div style="width:22px;"></div>
                    </div>
                    <div class="mock-content">
                      <div class="mock-row sm"></div>
                      <div class="mock-code">7CPV33LKXWLA</div>
                      <div class="mock-row xs"></div>
                      <div class="mock-actions">
                        <div class="mock-button primary">Copy</div>
                        <div class="mock-button">Open Billing</div>
                      </div>
                      <div class="mock-row xs"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="step-row">
              <div class="step-index">4</div>
              <div class="step-body">
                <h3>Redeem on Billing</h3>
                <p>Go to Billing → “Redeem a code,” paste your code, and submit. Your balance updates immediately.</p>
                <div class="step-media">
                  <div class="mock-window">
                    <div class="mock-topbar">
                      <div class="mock-dots">
                        <span class="mock-dot red"></span>
                        <span class="mock-dot yellow"></span>
                        <span class="mock-dot green"></span>
                      </div>
                      <div class="mock-title">Billing • Redeem</div>
                      <div style="width:22px;"></div>
                    </div>
                    <div class="mock-content">
                      <div class="mock-panel">
                        <div class="mock-row md"></div>
                        <div class="mock-progress"><span></span></div>
                        <div class="mock-input"></div>
                        <div class="mock-row xs"></div>
                        <div class="mock-actions">
                          <div class="mock-button primary">Redeem</div>
                          <div class="mock-button">Refresh</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="step-row">
              <div class="step-index">5</div>
              <div class="step-body">
                <h3>Check your balance</h3>
                <p>If the balance doesn’t refresh, click “Refresh” on the Billing page.</p>
                <div class="step-media">
                  <div class="mock-window">
                    <div class="mock-topbar">
                      <div class="mock-dots">
                        <span class="mock-dot red"></span>
                        <span class="mock-dot yellow"></span>
                        <span class="mock-dot green"></span>
                      </div>
                      <div class="mock-title">Billing • Account Status</div>
                      <div style="width:22px;"></div>
                    </div>
                    <div class="mock-content">
                      <div class="mock-panel">
                        <div class="mock-pill active"><span class="dot"></span> Signed in</div>
                        <div class="mock-row md"></div>
                        <div class="mock-row lg"></div>
                        <div class="mock-actions">
                          <div class="mock-button primary">Refresh Credits</div>
                          <div class="mock-button">Support</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="legal-card">
          <h2>Help</h2>
          <ul class="legal-list">
            <li>Codes are not automatic—redeem them on the Billing page.</li>
            <li>Each code can be used once and must match exactly.</li>
            <li>If credits don’t appear, refresh the billing page.</li>
            <li>Most credits post within a few minutes.</li>
            <li>Contact support if a credit is missing after 24 hours.</li>
          </ul>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="footer-inner">
        <span>© 2026 WriterPro</span>
        <div class="footer-links">
          <a href="terms.html">Terms</a>
          <a href="privacy.html">Privacy</a>
        </div>
      </div>
    </footer>

    <script>
      const SUPABASE_URL = "https://vnzlaidwxgiaowhxtuvi.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuemxhaWR3eGdpYW93aHh0dXZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjcwNzksImV4cCI6MjA4NDQwMzA3OX0.AKiGX3xbgMKtUFYxHKEaAKwacFqmjPEsy56ofU1eDQQ";
      const referralCodeEl = document.getElementById("referral-code");
      const copyReferralBtn = document.getElementById("copy-referral");
      const referralStatus = document.getElementById("referral-status");
      const referralSignIn = document.getElementById("referral-signin");
      let session = null;

      function loadSession() {
        try {
          const raw = localStorage.getItem("wp_session");
          const fallback = sessionStorage.getItem("wp_session");
          if (raw || fallback) session = JSON.parse(raw || fallback);
        } catch {
          session = null;
        }
      }

      function getAccessToken() {
        return session && session.access_token ? session.access_token : "";
      }

      function getRefreshToken() {
        return session && session.refresh_token ? session.refresh_token : "";
      }

      function hasSessionToken() {
        return !!getAccessToken();
      }

      async function supabaseRequest(path, options) {
        const headers = options.headers || {};
        headers["apikey"] = SUPABASE_ANON_KEY;
        if (hasSessionToken()) headers["Authorization"] = `Bearer ${getAccessToken()}`;
        return fetch(`${SUPABASE_URL}${path}`, { ...options, headers });
      }

      async function refreshSession() {
        if (!getRefreshToken()) return false;
        try {
          const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=refresh_token`, {
            method: "POST",
            headers: { "Content-Type": "application/json", apikey: SUPABASE_ANON_KEY },
            body: JSON.stringify({ refresh_token: getRefreshToken() })
          });
          if (!res.ok) return false;
          const next = await res.json();
          if (!next || !next.access_token) return false;
          session = next;
          try {
            const serialized = JSON.stringify(next);
            localStorage.setItem("wp_session", serialized);
            sessionStorage.setItem("wp_session", serialized);
            window.name = `wp_session:${serialized}`;
          } catch {}
          return true;
        } catch {
          return false;
        }
      }

      async function getUser() {
        if (!hasSessionToken()) return null;
        try {
          const res = await supabaseRequest("/auth/v1/user", { method: "GET" });
          if (res.ok) return await res.json();
          if (res.status === 401) {
            const refreshed = await refreshSession();
            if (!refreshed) return null;
            const retry = await supabaseRequest("/auth/v1/user", { method: "GET" });
            if (retry.ok) return await retry.json();
          }
          return null;
        } catch {
          return null;
        }
      }

      async function loadReferralCode() {
        referralStatus.textContent = "";
        referralSignIn.style.display = "none";

        loadSession();
        if (!hasSessionToken()) {
          referralStatus.textContent = "Sign in to view and copy your referral code.";
          referralSignIn.style.display = "inline-flex";
          return;
        }

        const user = await getUser();
        const userId = user && user.id ? user.id : "";
        if (!userId) {
          referralStatus.textContent = "Session expired. Please sign in again.";
          referralSignIn.style.display = "inline-flex";
          return;
        }

        try {
          const res = await supabaseRequest(`/rest/v1/profiles?id=eq.${userId}&select=referral_code`, { method: "GET" });
          if (!res.ok) {
            referralStatus.textContent = "Could not load referral code.";
            return;
          }
          const rows = await res.json();
          const code = rows && rows[0] && rows[0].referral_code ? rows[0].referral_code : "";
          if (!code) {
            referralStatus.textContent = "Referral code not found for this account yet. Refresh and try again.";
            return;
          }
          referralCodeEl.textContent = code;
        } catch {
          referralStatus.textContent = "Could not load referral code.";
        }
      }

      function navigateWithFade(url) {
        document.body.classList.add("page-exit");
        setTimeout(() => { window.location.href = url; }, 240);
      }
      document.querySelectorAll(".page-link").forEach((link) => {
        link.addEventListener("click", (event) => {
          const href = link.getAttribute("href") || "";
          if (href.startsWith("#")) return;
          event.preventDefault();
          navigateWithFade(href);
        });
      });

      copyReferralBtn.addEventListener("click", async () => {
        const code = (referralCodeEl.textContent || "").trim();
        if (!code || code === "—") {
          referralStatus.textContent = "Sign in to copy your referral code.";
          referralSignIn.style.display = "inline-flex";
          return;
        }
        try {
          await navigator.clipboard.writeText(code);
          referralStatus.textContent = "Copied referral code.";
          setTimeout(() => { if (referralStatus.textContent === "Copied referral code.") referralStatus.textContent = ""; }, 1200);
        } catch {
          referralStatus.textContent = "Copy failed. Select the code and copy it manually.";
        }
      });

      loadReferralCode();
    </script>
  </body>
</html>
